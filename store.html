<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢é€šç¥­æ ¸éŠ·æƒæ</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            margin: 0; padding: 0;
            background-color: #000; /* å…¨é»‘èƒŒæ™¯ */
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        /* --- ç›¸æ©Ÿå®¹å™¨ (åº•å±¤) --- */
        #camera-view {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        #qr-reader {
            width: 100%; height: 100%; object-fit: cover;
            position: absolute; top: 0; left: 0; z-index: 1;
        }

        /* --- ä»‹é¢åœ–å±¤ (è¦†è“‹åœ¨ç›¸æ©Ÿä¸Š) --- */
        .overlay-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10; /* åœ¨ç›¸æ©Ÿä¹‹ä¸Š */
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 40px 20px; box-sizing: border-box;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ç›¸æ©Ÿ */
            transition: all 0.3s ease;
        }

        /* --- ç‹€æ…‹ 1: å¾…æ©Ÿæƒæä¸­ --- */
        #state-scanning { background: rgba(0,0,0,0.3); }
        .scan-frame {
            width: 280px; height: 280px;
            border: 2px solid rgba(255,255,255,0.7); border-radius: 20px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); /* å¤–éƒ¨é®ç½© */
        }
        .scan-tip {
            margin-top: 20px; padding: 10px 20px;
            background: rgba(0,0,0,0.6); color: #fff; border-radius: 50px;
            font-size: 16px;
        }

        /* --- ç‹€æ…‹ 2: è™•ç†ä¸­ (Loading) --- */
        #state-loading { background: rgba(0,0,0,0.7); color: white; }
        .loading-spinner { font-size: 50px; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- ç‹€æ…‹ 3: çµæœè¨Šæ¯å¡ç‰‡ (æˆåŠŸ/å¤±æ•—) --- */
        .result-card {
            width: 85%; max-width: 340px;
            padding: 30px 20px; border-radius: 16px;
            text-align: center; color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            pointer-events: auto; /* å¡ç‰‡å¯ä»¥é»æ“Š */
            transform: translateY(20px); opacity: 0; transition: all 0.4s ease-out;
        }
        /* å¡ç‰‡å‡ºç¾å‹•ç•« */
        .result-card.show { transform: translateY(0); opacity: 1; }

        /* æˆåŠŸæ¨£å¼ (ç¶ è‰²) */
        .card-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .success-btn { background: #27ae60; }

        /* å¤±æ•—/é‡è¤‡æ¨£å¼ (ç´…è‰²/é»ƒè‰²) */
        .card-error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .error-btn { background: #c0392b; }
        .card-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #333; }
        .warning-btn { background: #d35400; color: white; }
        
        .result-title { font-size: 28px; font-weight: bold; margin: 15px 0; }
        .result-desc { font-size: 16px; line-height: 1.5; opacity: 0.9; }
        .card-btn {
            margin-top: 25px; padding: 12px 30px;
            border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* --- åº•éƒ¨åº—å®¶åç¨± --- */
        .store-footer {
            color: rgba(255,255,255,0.6);
            font-size: 16px; font-weight: bold;
            padding-bottom: 20px;
        }

        /* --- å·¥å…·é¡ --- */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="camera-view">
        <div id="qr-reader"></div>
    </div>

    <div id="state-scanning" class="overlay-layer">
        <div style="flex:1"></div> <div class="scan-frame"></div>
        <div class="scan-tip">è«‹å°æº–è¡Œå‹•æ¢ç¢¼</div>
        <div style="flex:1"></div> <div class="store-footer" id="footer-scan">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="state-loading" class="overlay-layer hidden">
        <div style="flex:1"></div>
        <div class="loading-spinner">â³</div>
        <div style="margin-top: 20px; font-size: 20px;">é›²ç«¯é©—è­‰ä¸­...</div>
        <div style="flex:1"></div>
        <div class="store-footer" id="footer-load"></div>
    </div>

    <div id="state-result" class="overlay-layer hidden" style="background: rgba(0,0,0,0.8);">
        <div style="flex:1"></div>
        
        <div id="result-card-body" class="result-card">
            <div style="font-size: 60px;" id="res-icon">âœ…</div>
            <div class="result-title" id="res-title">æ ¸éŠ·æˆåŠŸ</div>
            <div class="result-desc" id="res-desc">
                </div>
            <button class="card-btn" id="res-btn" onclick="resetScan()">ç¹¼çºŒæƒæ</button>
        </div>

        <div style="flex:1"></div>
        <div class="store-footer" id="footer-res"></div>
    </div>


    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
    // --- è¨­å®šèˆ‡åˆå§‹åŒ– ---
    // ğŸ‘‡ è«‹ç¢ºèªé€™æ˜¯ä¸æ˜¯æ‚¨æœ€æ–°çš„ Google Apps Script ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzhh_1BWbFNwumkrE7P3o0lwp5Ea6v9aCN3zK0DY__B3BOX_o47bAI6K5MLiMj2aF1b/exec";
    
    const storeName = localStorage.getItem('storeName');
    if (!storeName) { location.href = 'store-login.html'; }

    // å°‡åº—åå¡«å…¥æ‰€æœ‰ footer
    document.querySelectorAll('.store-footer').forEach(el => el.textContent = storeName);

    // --- UI åˆ‡æ›æ§åˆ¶ ---
    const states = {
        scan: document.getElementById('state-scanning'),
        load: document.getElementById('state-loading'),
        result: document.getElementById('state-result')
    };
    const resultCard = document.getElementById('result-card-body');

    function switchState(stateName) {
        Object.values(states).forEach(el => el.classList.add('hidden'));
        states[stateName].classList.remove('hidden');
        
        if (stateName === 'result') {
            setTimeout(() => resultCard.classList.add('show'), 50); // è§¸ç™¼å‹•ç•«
        } else {
            resultCard.classList.remove('show');
        }
    }

    // --- é¡¯ç¤ºçµæœå¡ç‰‡ ---
    function showResultCard(type, title, message) {
        const icon = document.getElementById('res-icon');
        const titleEl = document.getElementById('res-title');
        const descEl = document.getElementById('res-desc');
        const btn = document.getElementById('res-btn');

        // é‡ç½®æ¨£å¼
        resultCard.className = 'result-card';
        btn.className = 'card-btn';

        // æ ¹æ“šé¡å‹è¨­å®šæ¨£å¼
        if (type === 'success') {
            resultCard.classList.add('card-success');
            btn.classList.add('success-btn');
            icon.textContent = 'âœ…';
            btn.textContent = 'æƒææˆåŠŸ';
        } else if (type === 'warning') { // é‡è¤‡æ ¸éŠ·
            resultCard.classList.add('card-warning');
            btn.classList.add('warning-btn');
            icon.textContent = 'âš ï¸';
            btn.textContent = 'éŒ¯èª¤';
        } else { // å…¶ä»–å¤±æ•—
            resultCard.classList.add('card-error');
            btn.classList.add('error-btn');
            icon.textContent = 'âŒ';
            btn.textContent = 'æƒæå¤±æ•—';
        }

        titleEl.textContent = title;
        descEl.innerHTML = message; // å…è¨± HTML ä»¥é¡¯ç¤ºæ›è¡Œ
        switchState('result');
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå‘¼å« Google å¤§è…¦ ---
    async function updateCheckin(id) {
        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ id: id, storeName: storeName })
            });
            const data = await res.json();
            return data;
        } catch (e) {
            console.error(e);
            return { result: 'error', message: 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨Šè™Ÿ' };
        }
    }

    // --- æƒæè™•ç†æµç¨‹ ---
    let isProcessing = false;
    const html5QrCode = new Html5Qrcode('qr-reader');

    async function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true;
        html5QrCode.pause(true);
        switchState('load'); // 1. åˆ‡æ›åˆ°è¼‰å…¥ä¸­

        // 2. å‘¼å« Google
        const data = await updateCheckin(decodedText);

        // 3. æ ¹æ“šçµæœé¡¯ç¤ºå°æ‡‰å¡ç‰‡
        if (data.result === 'ok') {
            // æˆåŠŸï¼šé¡¯ç¤ºç¶ è‰²å¡ç‰‡
            // data.message è£¡å·²ç¶“åŒ…å«äº†ç¥¨ç¨®å’Œæ—¥æœŸï¼Œç›´æ¥é¡¯ç¤º
            showResultCard('success', 'è«‹æä¾›ç†Ÿå®¢å„ªæƒ ', data.message.replace('<br>', '<div style="margin-top:8px; font-size:0.9em">') + '</div>');
        } else {
            // å¤±æ•—ï¼šåˆ¤æ–·æ˜¯é‡è¤‡é‚„æ˜¯å…¶ä»–éŒ¯èª¤
            if (data.message.includes('æœ¬åº—å·²æ ¸éŠ·')) {
                // é‡è¤‡æ ¸éŠ·ï¼šé¡¯ç¤ºé»ƒè‰²/æ©˜è‰²å¡ç‰‡
                showResultCard('warning', 'æœ¬æ¢ç¢¼å·²æ ¸éŠ·é', data.message);
            } else {
                // å…¶ä»–éŒ¯èª¤ (éæœŸã€ç„¡æ•ˆ)ï¼šé¡¯ç¤ºç´…è‰²å¡ç‰‡
                showResultCard('error', 'æœ¬è¡Œå‹•æ¢ç¢¼ç„¡æ•ˆ', data.message.replace('<br>', '<div style="margin-top:8px">') + '</div>');
            }
        }
        // æ³¨æ„ï¼šé€™è£¡ä¸å†è‡ªå‹•æ¢å¾©ï¼Œéœ€ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•
    }

    // --- æ¢å¾©æƒæ ---
    function resetScan() {
        switchState('scan');
        html5QrCode.resume();
        isProcessing = false;
    }

    // --- å•Ÿå‹•ç›¸æ©Ÿ ---
    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(() => html5QrCode.start({ facingMode: "user" }, config, onScanSuccess));

    </script>
</body>
</html>
