<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>條通祭核銷掃描</title>
    <style>
        /* --- 全域設定 --- */
        html, body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            width: 100%; height: 100%;
            overflow: hidden; /* 防止捲動 */
        }

        /* --- 相機區域 (回歸舊版邏輯) --- */
        #camera-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #000;
            z-index: 0;
        }
        #qr-reader {
            width: 100%;
            /* 這裡不強制 height: 100%，讓它保持比例，這樣才掃得到！ */
            max-height: 100%; 
        }
        /* 讓影片水平置中，不要被硬拉變形 */
        #qr-reader video {
            object-fit: contain !important; 
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* --- 介面圖層 --- */
        .overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 40px 20px;
            padding-bottom: env(safe-area-inset-bottom, 40px);
            box-sizing: border-box;
            pointer-events: none; /* 讓點擊穿透 */
        }

        /* --- 1. 啟動按鈕介面 --- */
        #state-start { 
            background: #000; z-index: 20; pointer-events: auto;
            justify-content: center; text-align: center;
        }
        .start-btn {
            background: #1B9A4B; color: white; border: none; padding: 18px 50px;
            font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(27, 154, 75, 0.5);
        }
        .reload-link { color: #666; text-decoration: underline; font-size: 14px; margin-top: 30px; cursor: pointer; }

        /* --- 2. 掃描中介面 --- */
        #state-scanning { background: rgba(0,0,0,0.3); } /* 半透明黑底 */
        
        .scan-frame {
            position: relative; width: 250px; height: 250px;
            border: 2px solid rgba(255,255,255,0.8); border-radius: 20px;
            /* 這裡拿掉那個厚重的陰影，避免造成視覺干擾，舊版就沒有那個 */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .scan-tip {
            margin-top: 20px; padding: 8px 24px;
            background: rgba(0,0,0,0.6); color: #fff; 
            border-radius: 50px; font-size: 16px; letter-spacing: 1px;
        }

        /* --- 3. 載入與結果 --- */
        #state-loading { background: rgba(0,0,0,0.85); color: white; justify-content: center; }
        .result-card {
            width: 90%; max-width: 320px;
            padding: 30px 20px; border-radius: 20px;
            text-align: center; color: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            pointer-events: auto; background: #222;
            display: none; /* 預設隱藏 */
        }
        #state-result { background: rgba(0,0,0,0.85); justify-content: center; }

        /* 結果卡片樣式 */
        .card-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .card-error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .card-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #222; }
        
        .result-title { font-size: 26px; font-weight: bold; margin: 15px 0 10px 0; }
        .result-desc { font-size: 16px; line-height: 1.5; opacity: 0.95; margin-bottom: 20px;}
        .card-btn {
            width: 100%; padding: 12px 0; border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .store-footer { color: rgba(255,255,255,0.6); font-size: 14px; font-weight: bold; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="camera-container">
        <div id="qr-reader"></div>
    </div>

    <div id="state-start" class="overlay-layer">
        <div style="flex:1"></div>
        <div>
            <button id="btn-start" class="start-btn" onclick="startCamera()">啟動掃描器</button>
            <div style="margin-top:20px; color:#888;">請點擊按鈕開啟相機</div>
            <div class="reload-link" onclick="location.reload()">重新整理</div>
        </div>
        <div style="flex:1"></div>
        <div class="store-footer"></div>
    </div>

    <div id="state-scanning" class="overlay-layer hidden">
        <div style="flex:1"></div>
        <div class="scan-frame"></div>
        <div class="scan-tip">請對準行動條碼</div>
        <div style="flex:1"></div>
        <div class="store-footer"></div>
    </div>

    <div id="state-loading" class="overlay-layer hidden">
        <div style="font-size: 20px; font-weight:bold;">雲端驗證中...</div>
    </div>

    <div id="state-result" class="overlay-layer hidden">
        <div id="result-card-body" class="result-card">
            <div style="font-size: 60px;" id="res-icon">✅</div>
            <div class="result-title" id="res-title"></div>
            <div class="result-desc" id="res-desc"></div>
            <button class="card-btn" id="res-btn" onclick="resetScan()">繼續掃描</button>
        </div>
        <div class="store-footer" style="position: absolute; bottom: 40px;"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzhh_1BWbFNwumkrE7P3o0lwp5Ea6v9aCN3zK0DY__B3BOX_o47bAI6K5MLiMj2aF1b/exec";
    const storeName = localStorage.getItem('storeName');
    if (!storeName) { location.href = 'store-login.html'; }
    document.querySelectorAll('.store-footer').forEach(el => el.textContent = storeName);

    // 全域變數：只初始化一次！
    const html5QrCode = new Html5Qrcode("qr-reader");
    const resultCard = document.getElementById('result-card-body');

    // UI 切換
    function switchState(stateName) {
        document.getElementById('state-start').classList.add('hidden');
        document.getElementById('state-scanning').classList.add('hidden');
        document.getElementById('state-loading').classList.add('hidden');
        document.getElementById('state-result').classList.add('hidden');
        
        document.getElementById('state-' + stateName).classList.remove('hidden');

        if (stateName === 'result') {
            resultCard.style.display = 'block';
        }
    }

    // 啟動相機 (完全使用舊版邏輯)
    function startCamera() {
        document.getElementById('btn-start').innerText = "啟動中...";
        
        // 舊版最簡單的設定：不指定解析度、不指定 aspectRatio
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 } 
        };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).then(() => {
            switchState('scanning'); // 成功後切換介面
            document.getElementById('btn-start').innerText = "啟動掃描器";
        }).catch(err => {
            alert("相機啟動失敗：" + err);
            document.getElementById('btn-start').innerText = "啟動失敗，點此重試";
            location.reload(); // 失敗直接重整，這是解決 Safari 卡死的最好方法
        });
    }

    // 掃描成功
    function onScanSuccess(decodedText) {
        // 暫停掃描
        html5QrCode.pause(true);
        switchState('loading');

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ id: decodedText, storeName: storeName })
        })
        .then(res => res.json())
        .then(data => {
            showResult(data);
        })
        .catch(err => {
            showResult({ result: 'error', message: '網路錯誤' });
        });
    }

    // 顯示結果
    function showResult(data) {
        switchState('result');
        const titleEl = document.getElementById('res-title');
        const descEl = document.getElementById('res-desc');
        const iconEl = document.getElementById('res-icon');
        const btn = document.getElementById('res-btn');

        resultCard.className = 'result-card'; // 重置 class

        if (data.result === 'ok') {
            resultCard.classList.add('card-success');
            iconEl.innerText = '✅';
            titleEl.innerText = '核銷成功';
            descEl.innerHTML = data.message;
        } else if (data.message && data.message.includes('本店已核銷')) {
            resultCard.classList.add('card-warning');
            iconEl.innerText = '⚠️';
            titleEl.innerText = '重複核銷';
            descEl.innerHTML = data.message;
        } else {
            resultCard.classList.add('card-error');
            iconEl.innerText = '❌';
            titleEl.innerText = '無效票券';
            descEl.innerHTML = data.message || '查無資料';
        }
    }

    // 繼續掃描
    function resetScan() {
        switchState('scanning');
        html5QrCode.resume();
    }
    </script>
</body>
</html>
