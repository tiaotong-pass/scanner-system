<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>2025條通祭：店家兌換檢核頁面</title>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #333;
            background-image: url('img/bg.png');
            background-repeat: no-repeat;
            background-position: top center;
            background-size: auto 100%;
        }
        @media (max-width: 999px) {
            body {
                background-size: 100% auto;
                background-position: center 15%;
                overflow: hidden;
            }
        }
        #main-container {
            width: 100%;
            max-width: 400px;
            padding: 1em;
            box-sizing: border-box;
            text-align: center;
        }
        #camera-wrapper {
            position: relative;
            width: 80%;
            background: url('img/camera.png') no-repeat center center;
            margin: 0 auto;
            background-size: 76% 97%;
            margin: 0 auto;
            padding-top: 10%;
            padding-right: 3%;
            padding-bottom: 3%;
        }
        #qr-reader {
            width: 70%;
            margin: auto;
            aspect-ratio: 1 / 1;
            overflow: hidden;
        }
        #qr-reader video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
        }
        h1 {
            color: #ffffff;
        }
        #store-name {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80vw;
            margin: 0 auto;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <h1 style="padding-top: 3.5em;"><span id="store-name"></span></h1>
        <div id="camera-wrapper">
            <div id="qr-reader"></div>
        </div>
        <div id="status"></div>
    </div>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
    const TOTAL_STORES = 47;
    const storeIndex = parseInt(localStorage.getItem('storeIndex') || '0', 10);
    const storeName = localStorage.getItem('storeName') || '';
    if (!storeIndex || !storeName) {
        location.href = 'store-login.html';
    }
    const storeNameEl = document.getElementById('store-name');
    storeNameEl.textContent = storeName;

    function adjustStoreNameFont() {
        let size = 2.0;
        storeNameEl.style.fontSize = size + 'em';
        const maxWidth = Math.min(storeNameEl.parentElement.clientWidth,
                                  window.innerWidth * 0.8);
        while (storeNameEl.scrollWidth > maxWidth && size > 0.5) {
            size -= 0.1;
            storeNameEl.style.fontSize = size.toFixed(1) + 'em';
        }
    }
    adjustStoreNameFont();
    window.addEventListener('resize', adjustStoreNameFont);

    let PARTICIPANTS = [];
    async function loadParticipants() {
        const res = await fetch('participants.txt');
        const text = await res.text();
        PARTICIPANTS = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    }

async function updateCheckin(id) {
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzhh_1BWbFNwumkrE7P3o0lwp5Ea6v9aCN3zK0DY__B3BOX_o47bAI6K5MLiMj2aF1b/exec";
        
        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ id: id, storeName: storeName })
            });
            
            const data = await res.json();
            
            const statusEl = document.getElementById('status');
            
            if (data.result === "ok") {
                setStatus('ok');
                statusEl.innerHTML += `<div style="color:white; font-size:16px; margin-top:5px;">${data.message}</div>`;
            } else if (data.result === "invalid") {
                setStatus('invalid');
                statusEl.innerHTML += `<div style="color:red; font-size:16px; margin-top:5px;">${data.message}</div>`;
            } else {
                setStatus('Server error');
            }
            
            return data;
        } catch (e) {
            console.error(e);
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<h3 style="color:red">連線錯誤，請重試</h3>`;
            return { result: 'error' };
        }
    }

    function setStatus(type) {
        const el = document.getElementById('status');
        let src = null;
        if (type === 'ok') src = 'img/code_ok.png';
        else if (type === 'already') src = 'img/code_already.png';
        else if (type === 'invalid') src = 'img/code_invalid.png';
        else if (type === 'not_checkin') src = 'img/not_checkin.png';
        if (src) {
            el.innerHTML = `<img src="${src}" style="width:80%">`;
        } else {
            el.style.color = 'red';
            el.textContent = type;
        }
    }

    function clearStatus() {
        const el = document.getElementById('status');
        el.textContent = '';
        el.innerHTML = '';
    }

    let resumeTimeout = null;
    async function onScanSuccess(decodedText) {
        if (resumeTimeout) return;
        html5QrCode.pause(true);

        let pauseMs = 1000;
        if (PARTICIPANTS.includes(decodedText)) {
            try {
                const data = await updateCheckin(decodedText);
                if (data.notCheckin) {
                    setStatus('not_checkin');
                    pauseMs = 1000;
                } else if (data.already) {
                    setStatus('already');
                    pauseMs = 1000;
                } else {
                    setStatus('ok');
                    pauseMs = 3000;
                }
            } catch (e) {
                setStatus('Server error');
            }
        } else {
            setStatus('invalid');
            pauseMs = 1000;
        }
        resumeTimeout = setTimeout(() => {
            clearStatus();
            html5QrCode.resume();
            resumeTimeout = null;
        }, pauseMs);
    }

    const qrboxFunction = function(viewfinderWidth, viewfinderHeight) {
        let minEdgePercentage = 0.7; // 70%
        let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
        let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
        return {
            width: qrboxSize,
            height: qrboxSize
        };
    };

    const html5QrCode = new Html5Qrcode('qr-reader');
    const config = { fps: 10, qrbox: qrboxFunction, aspectRatio: 1.0 };

    loadParticipants().then(() => {
        html5QrCode.start({ facingMode: 'environment' }, config, onScanSuccess)
          .catch(err => {
            console.warn('Falling back to default camera', err);
            html5QrCode.start({ facingMode: 'user' }, config, onScanSuccess)
              .catch(err2 => console.error(err2));
          });
    });
    </script>
</body>
</html>
