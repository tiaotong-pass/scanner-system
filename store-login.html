<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>條通祭店家登入</title>
    <style>
        /* --- 風格設定 --- */
        body {
            margin: 0; padding: 0;
            background-color: #F0F0F0;
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh;
            border: 16px solid #231815;
            box-sizing: border-box;
        }

        /* --- 內容容器 --- */
        .content-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%;
        }

        /* --- Logo 區域 --- */
        #logo-container { margin-bottom: 40px; text-align: center; }
        #logo-img { width: 180px; height: auto; margin-bottom: 10px; min-height: 50px; }
        #logo-text { font-size: 14px; color: #59493F; letter-spacing: 1px; font-weight: bold; }

        /* --- 輸入框與按鈕 --- */
        .input-group {
            display: flex; flex-direction: column; gap: 20px;
            width: 80%; max-width: 320px;
            align-items: center;
        }

        #store-code {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            background-color: #FFFFFF; font-size: 18px; text-align: center; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); outline: none; box-sizing: border-box;
        }
        #login-btn {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            background-color: #1B9A4B; font-size: 20px; font-weight: bold; color: white;
            cursor: pointer; box-shadow: 0 4px 10px rgba(27, 154, 75, 0.3);
            transition: background-color 0.2s; box-sizing: border-box;
        }
        #login-btn:active { background-color: #147A3B; }
        #login-btn:disabled { background-color: #ccc; cursor: not-allowed; } /* 新增禁用樣式 */

        /* --- 錯誤訊息 --- */
        #error-msg {
            margin-top: 25px; color: #C0392B; font-weight: bold; font-size: 16px;
            display: none; align-items: center; gap: 5px;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div id="logo-container">
            <img id="logo-img" src="img/logo.png" alt="LOGO" onerror="this.style.opacity=0.3;">
            <div id="logo-text">臺北市條通商圈產業發展促進會</div>
        </div>

        <div class="input-group">
            <input type="text" id="store-code" placeholder="請輸入店家密碼" inputmode="numeric">
            <button id="login-btn">登入熟客券系統</button>
        </div>

        <div id="error-msg"></div>
    </div>

    <script>
        // ★★★ 設定：請填入您的 Google Apps Script 網址 ★★★
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzhh_1BWbFNwumkrE7P3o0lwp5Ea6v9aCN3zK0DY__B3BOX_o47bAI6K5MLiMj2aF1b/exec";

        let storeData = {};
        const loginBtn = document.getElementById('login-btn');
        const codeInput = document.getElementById('store-code');
        const errorMsg = document.getElementById('error-msg');

        // 讀取外部檔案
        fetch('store_table.txt?v=' + new Date().getTime())
            .then(res => {
                if (!res.ok) throw new Error("找不到名單檔案");
                return res.json();
            })
            .then(data => {
                storeData = data;
                console.log("店家名單載入成功", Object.keys(data).length + " 筆");
            })
            .catch(err => {
                console.error("載入失敗:", err);
                errorMsg.style.display = 'flex';
                errorMsg.textContent = "⚠️ 系統載入中或格式錯誤，請重新整理";
            });

        loginBtn.addEventListener('click', performLogin);
        codeInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') performLogin(); });

        function performLogin() {
            const inputCode = codeInput.value.trim();
            errorMsg.style.display = 'none';

            // 檢查名單是否已載入
            if (Object.keys(storeData).length === 0) {
                errorMsg.style.display = 'flex';
                errorMsg.textContent = "⏳ 資料載入中，請稍後再試...";
                location.reload(); 
                return;
            }

            let foundStoreName = null;
            for (const [name, code] of Object.entries(storeData)) {
                if (code === inputCode) { foundStoreName = name; break; }
            }

            if (foundStoreName) {
                // --- 登入成功 ---
                
                // 1. UI 變更：避免使用者重複點擊，給予回饋
                loginBtn.innerText = "驗證成功，登入中...";
                loginBtn.disabled = true;

                // 2. 寫入本地儲存
                localStorage.setItem('storeName', foundStoreName);
                localStorage.setItem('storeIndex', inputCode);

                // 3. ★★★ 關鍵修改：發送登入紀錄給 GAS ★★★
                // 使用 no-cors 模式發後不理，速度最快
                try {
                    fetch(GAS_URL, {
                        method: "POST",
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: "login",       // 告訴後端這是登入動作
                            storeName: foundStoreName // 說是哪家店
                        })
                    });
                } catch (e) {
                    console.error("Log發送失敗，但不影響登入");
                }

                // 4. 延遲跳轉 (為了確保上面的 fetch 訊號有時間發出去)
                setTimeout(() => {
                    location.href = 'store.html';
                }, 500); // 延遲 0.5 秒
                
            } else {
                // --- 登入失敗 ---
                errorMsg.style.display = 'flex';
                errorMsg.textContent = "✖ 密碼錯誤，請重新輸入";
                codeInput.value = '';
                codeInput.focus();
            }
        }
    </script>
</body>
</html>
